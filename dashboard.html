<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cửa Hàng - GENSAISHOP</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-inner">
            <img class="logo-img" onclick="window.location.href='index.html'" alt="GENSAI SHOP">
            
            <div style="display:flex; align-items:center;">
                <div class="bell-wrapper" onclick="toggleNotif()">
                    <i class="fa-solid fa-bell"></i>
                    <div id="bell-dot" class="bell-dot"></div>
                    <div id="notif-box" class="notif-box">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#fff;">Thông Báo</h4>
                        <div id="notif-content"></div>
                    </div>
                </div>
                <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
            </div>
            
            <div class="mobile-menu" id="mainMenu"></div>
        </div>
    </nav>

    <div class="container">
        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center">
            <h3 style="font-size:16px; color:#fff">Chào, <span id="uName" style="color:#3b82f6">...</span></h3>
            <div style="font-size:14px; font-weight:bold; color:#fff">Số dư: <span id="uBal" style="color:#22c55e">0</span>đ</div>
        </div>

        <div class="section-header"><i class="fa-solid fa-ticket"></i> Mua Gamepass</div>
        <div class="grid">
            <div class="card">
                <img src="https://i.postimg.cc/7Lrp7X49/tum-voucherler-bee-swarm-13751871.png">
                <div class="card-body">
                    <div class="card-title">Bear Bee Voucher</div>
                    <div class="price">120.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Bear Bee Voucher', 120000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/3wZbGT9c/tum-voucherler-bee-swarm-13751871-1.png">
                <div class="card-body">
                    <div class="card-title">Cub Buddy Voucher</div>
                    <div class="price">80.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Cub Buddy Voucher', 80000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/Px336Qg7/tum-voucherler-bee-swarm-13751871-2.png">
                <div class="card-body">
                    <div class="card-title">x2 Bee Gather</div>
                    <div class="price">60.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Bee Gather', 60000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/WpyYgS6N/tum-voucherler-bee-swarm-13751871-3.png">
                <div class="card-body">
                    <div class="card-title">x2 Convert Speed</div>
                    <div class="price">60.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Convert Speed', 60000)">MUA NGAY</button>
                </div>
            </div>
        </div>

        <div class="section-header" style="border-left-color: #3b82f6;"><i class="fa-solid fa-shield-halved"></i> Dịch vụ Cày Thuê</div>
        <div class="grid">
            
            <div class="card">
                <img src="https://i.postimg.cc/52vXFhkp/Picsart-26-01-30-13-32-27-533.png">
                <div class="card-body">
                    <div class="card-title">Basic Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Basic Mask', 0, ['Honey Mask', 'Fire Mask', 'Bubble Mask'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/d0LSB9rp/Picsart-26-01-30-13-27-53-922.png">
                <div class="card-body">
                    <div class="card-title">Advanced Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Advanced Mask', 0, ['Evil Mask', 'Diamond Mask', 'Gummy Mask'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/fRFvwQS5/Picsart-26-01-30-13-23-20-403.png">
                <div class="card-body">
                    <div class="card-title">Endgame Tools</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Endgame Tool', 0, ['Dark Scythe', 'Tide Popper', 'Gummyballer'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/cJtjMmNY/Screenshot-20260130-123550-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Honeycomb Belt</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Honeycomb Belt', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/C1jQ9x5p/Screenshot-20260130-123640-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Coconut Clogs</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Coconut Clogs', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0QmTxCtT/images-(17).jpg">
                <div class="card-body">
                    <div class="card-title">Gummy Boots</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Boots', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0jj7DVLC/Screenshot-20260130-125715-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Guards (Cobalt/Crimson)</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Guards', 0, ['Cobalt Guard', 'Crimson Guard'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/B6Vj94VB/images-(18).jpg">
                <div class="card-body">
                    <div class="card-title">Vicious Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Vicious Bee', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/pVmZ9TxS/Gummy-Bee.webp">
                <div class="card-body">
                    <div class="card-title">Gummy Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Bee', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:15px; color:#fff" id="modalTitle">...</h3>
            <p>Vật phẩm: <b id="mName">...</b></p>
            <p id="priceRow" style="margin-bottom:10px">Giá: <b id="mPrice" style="color:red">...</b></p>
            
            <div id="variantArea" class="variant-group" style="display:none"></div>
            <input type="text" id="accUser" class="input-box" placeholder="Username Roblox...">
            
            <div id="boostArea" style="display:none">
                <input type="password" id="accPass" class="input-box" placeholder="Mật khẩu (Bắt buộc)...">
                <label style="font-size:13px; font-weight:bold; display:block; margin:10px 0 5px; color:#ccc">Nguyên liệu & Tiền hiện có:</label>
                <textarea id="materialNote" class="input-box" style="height:60px" placeholder="Ví dụ: Đủ nl, 500 tỷ honey..."></textarea>
                
                <div class="upload-btn-wrapper">
                    <button class="btn-upload" id="uploadBtnText"><i class="fa-solid fa-camera"></i> Chọn ảnh tổ ong</button>
                    <input type="file" id="hiveImg" accept="image/*" onchange="compressImage(this)">
                </div>
                
                <div id="previewArea" style="display:none; text-align:center; margin-bottom:10px">
                    <img id="imgPreview" style="max-height:80px; border:1px solid #444; border-radius:8px">
                </div>

                <div style="font-size:11px; background:#222; padding:10px; border-radius:8px; color:#aaa; border:1px solid #333">
                    <i class="fa-solid fa-circle-info"></i> Dựa vào tình trạng acc, Admin sẽ báo giá lại sau.
                </div>
            </div>

            <button class="btn-primary" onclick="processOrder()">XÁC NHẬN</button>
            <button onclick="document.getElementById('buyModal').style.display='none'" style="width:100%; border:none; background:none; margin-top:10px; color:#888; cursor:pointer">Hủy</button>
        </div>
    </div>

     <script type="module">
    // 1. DÁN CẤU HÌNH FIREBASE CỦA BẠN VÀO ĐÂY
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBpQ0poFExribJApkGp4poilyTfepmnj9E",  // <--- THAY CÁI CỦA BẠN VÀO ĐÂY
        authDomain: "gensaishop-df392.firebaseapp.com",
        projectId: "gensaishop-df392",
        storageBucket: "gensaishop-df392.firebasestorage.app",
        messagingSenderId: "561693794311",
        appId: "1:561693794311:web:b1d78102189cc30ba44aa2"
    };

    // Khởi động Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- LOGIC CŨ GIỮ NGUYÊN ---
    if(!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
    const uName = localStorage.getItem('myUser');
    document.getElementById('uName').innerText = uName;

    // --- HÀM GỬI ĐƠN (SỬA LẠI DÙNG FIREBASE) ---
    window.processOrder = async function() {
        const acc = document.getElementById('accUser').value;
        const pass = document.getElementById('accPass').value || "Không cần";
        const note = document.getElementById('materialNote') ? document.getElementById('materialNote').value : "";
        
        if(!acc) return alert("Nhập tên acc!");

        const btn = document.querySelector('.btn-primary');
        btn.innerText = "Đang gửi...";
        btn.disabled = true;

        try {
            // Ghi thẳng vào Firebase (Không cần qua Render nữa)
            await addDoc(collection(db, "orders"), {
                acc: acc,
                pass: pass,
                service: window.currentItem.name,
                price: window.currentItem.price,
                type: window.currentItem.type,
                note: note,
                status: window.currentItem.type === 'gamepass' ? 'Chờ xử lý' : 'Đang xét giá',
                createdAt: new Date().toISOString() // Lưu thời gian
            });

            alert("Gửi đơn thành công! Admin đã nhận được ngay lập tức.");
            document.getElementById('buyModal').style.display = 'none';
        } catch (e) {
            console.error(e);
            alert("Lỗi gửi đơn: " + e.message);
        }
        btn.innerText = "XÁC NHẬN";
        btn.disabled = false;
    }

    // --- HÀM THÔNG BÁO REAL-TIME (CỰC XỊN) ---
    // Tự động báo chuông khi Admin đổi trạng thái đơn của user này
    const q = query(
        collection(db, "orders"), 
        where("acc", "==", uName), // Chỉ lấy đơn của user này
        where("status", "==", "Chờ xác nhận") // Chỉ lấy đơn Admin vừa báo giá
    );

    // onSnapshot: Luôn lắng nghe, server đổi cái là đây chạy ngay
    onSnapshot(q, (snapshot) => {
        if(!snapshot.empty) {
            document.getElementById('bell-dot').style.display = 'block';
            // Code hiện thông báo vào box... (như cũ)
        }
    });

    // Các hàm phụ trợ khác (openModal, toggleMenu...) giữ nguyên
    window.openModal = function(type, name, price) {
        // ... (Copy code cũ vào đây hoặc để bên ngoài module nhưng gán vào window)
        window.currentItem = { type, name, price };
        document.getElementById('mName').innerText = name;
        document.getElementById('buyModal').style.display = 'flex';
        // ...
    }
</script>
