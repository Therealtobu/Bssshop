<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C·ª≠a H√†ng - GENSAISHOP</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-inner">
            <img class="logo-img" onclick="window.location.href='index.html'" alt="GENSAI SHOP">
            
            <div style="display:flex; align-items:center;">
                <div class="bell-wrapper" onclick="toggleNotif()">
                    <i class="fa-solid fa-bell"></i>
                    <div id="bell-dot" class="bell-dot"></div>
                    <div id="notif-box" class="notif-box">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#fff;">Th√¥ng B√°o</h4>
                        <div id="notif-content"></div>
                    </div>
                </div>
                <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
            </div>
            
            <div class="mobile-menu" id="mainMenu"></div>
        </div>
    </nav>

    <div class="container">
        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center">
            <h3 style="font-size:16px; color:#fff">Ch√†o, <span id="uName" style="color:#3b82f6">...</span></h3>
            <div style="font-size:14px; font-weight:bold; color:#fff">S·ªë d∆∞: <span id="uBal" style="color:#22c55e">0</span>ƒë</div>
        </div>

        <div class="section-header"><i class="fa-solid fa-ticket"></i> Mua Gamepass</div>
        <div class="grid">
            <div class="card">
                <img src="https://i.postimg.cc/7Lrp7X49/tum-voucherler-bee-swarm-13751871.png">
                <div class="card-body">
                    <div class="card-title">Bear Bee Voucher</div>
                    <div class="price">120.000ƒë</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Bear Bee Voucher', 120000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/3wZbGT9c/tum-voucherler-bee-swarm-13751871-1.png">
                <div class="card-body">
                    <div class="card-title">Cub Buddy Voucher</div>
                    <div class="price">80.000ƒë</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Cub Buddy Voucher', 80000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/Px336Qg7/tum-voucherler-bee-swarm-13751871-2.png">
                <div class="card-body">
                    <div class="card-title">x2 Bee Gather</div>
                    <div class="price">60.000ƒë</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Bee Gather', 60000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/WpyYgS6N/tum-voucherler-bee-swarm-13751871-3.png">
                <div class="card-body">
                    <div class="card-title">x2 Convert Speed</div>
                    <div class="price">60.000ƒë</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Convert Speed', 60000)">MUA NGAY</button>
                </div>
            </div>
        </div>

        <div class="section-header" style="border-left-color: #3b82f6;"><i class="fa-solid fa-shield-halved"></i> D·ªãch v·ª• C√†y Thu√™</div>
        <div class="grid">
            
            <div class="card">
                <img src="https://i.postimg.cc/52vXFhkp/Picsart-26-01-30-13-32-27-533.png">
                <div class="card-body">
                    <div class="card-title">Basic Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Basic Mask', 0, ['Honey Mask', 'Fire Mask', 'Bubble Mask'])">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/d0LSB9rp/Picsart-26-01-30-13-27-53-922.png">
                <div class="card-body">
                    <div class="card-title">Advanced Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Advanced Mask', 0, ['Evil Mask', 'Diamond Mask', 'Gummy Mask'])">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/fRFvwQS5/Picsart-26-01-30-13-23-20-403.png">
                <div class="card-body">
                    <div class="card-title">Endgame Tools</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Endgame Tool', 0, ['Dark Scythe', 'Tide Popper', 'Gummyballer'])">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/cJtjMmNY/Screenshot-20260130-123550-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Honeycomb Belt</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Honeycomb Belt', 0)">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/C1jQ9x5p/Screenshot-20260130-123640-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Coconut Clogs</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Coconut Clogs', 0)">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0QmTxCtT/images-(17).jpg">
                <div class="card-body">
                    <div class="card-title">Gummy Boots</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Boots', 0)">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0jj7DVLC/Screenshot-20260130-125715-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Guards (Cobalt/Crimson)</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Guards', 0, ['Cobalt Guard', 'Crimson Guard'])">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/B6Vj94VB/images-(18).jpg">
                <div class="card-body">
                    <div class="card-title">Vicious Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Vicious Bee', 0)">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/pVmZ9TxS/Gummy-Bee.webp">
                <div class="card-body">
                    <div class="card-title">Gummy Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Th∆∞∆°ng l∆∞·ª£ng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Bee', 0)">ƒê·∫∂T ƒê∆†N</button>
                </div>
            </div>
        </div>
    </div>

    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:15px; color:#fff" id="modalTitle">...</h3>
            <p>V·∫≠t ph·∫©m: <b id="mName">...</b></p>
            <p id="priceRow" style="margin-bottom:10px">Gi√°: <b id="mPrice" style="color:red">...</b></p>
            
            <div id="variantArea" class="variant-group" style="display:none"></div>
            <input type="text" id="accUser" class="input-box" placeholder="Username Roblox...">
            
            <div id="boostArea" style="display:none">
                <input type="password" id="accPass" class="input-box" placeholder="M·∫≠t kh·∫©u (B·∫Øt bu·ªôc)...">
                <label style="font-size:13px; font-weight:bold; display:block; margin:10px 0 5px; color:#ccc">Nguy√™n li·ªáu & Ti·ªÅn hi·ªán c√≥:</label>
                <textarea id="materialNote" class="input-box" style="height:60px" placeholder="V√≠ d·ª•: ƒê·ªß nl, 500 t·ª∑ honey..."></textarea>
                
                <div class="upload-btn-wrapper">
                    <button class="btn-upload" id="uploadBtnText"><i class="fa-solid fa-camera"></i> Ch·ªçn ·∫£nh t·ªï ong</button>
                    <input type="file" id="hiveImg" accept="image/*" onchange="compressImage(this)">
                </div>
                
                <div id="previewArea" style="display:none; text-align:center; margin-bottom:10px">
                    <img id="imgPreview" style="max-height:80px; border:1px solid #444; border-radius:8px">
                </div>

                <div style="font-size:11px; background:#222; padding:10px; border-radius:8px; color:#aaa; border:1px solid #333">
                    <i class="fa-solid fa-circle-info"></i> D·ª±a v√†o t√¨nh tr·∫°ng acc, Admin s·∫Ω b√°o gi√° l·∫°i sau.
                </div>
            </div>

            <button class="btn-primary" onclick="processOrder()">X√ÅC NH·∫¨N</button>
            <button onclick="document.getElementById('buyModal').style.display='none'" style="width:100%; border:none; background:none; margin-top:10px; color:#888; cursor:pointer">H·ªßy</button>
        </div>
    </div>

<script type="module">
    // --- 1. K·∫æT N·ªêI FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // üëá D√ÅN API KEY C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëá
    apiKey: "AIzaSyBpQ0poFExribJApkGp4poilyTfepmnj9E",  // <--- THAY C√ÅI C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        authDomain: "gensaishop-df392.firebaseapp.com",
        projectId: "gensaishop-df392",
        storageBucket: "gensaishop-df392.firebasestorage.app",
        messagingSenderId: "561693794311",
        appId: "1:561693794311:web:b1d78102189cc30ba44aa2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    console.log("Firebase ƒë√£ k·∫øt n·ªëi!"); // Ki·ªÉm tra xem code c√≥ ch·∫°y kh√¥ng

    // --- 2. C√ÅC BI·∫æN TO√ÄN C·ª§C ---
    if(!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
    const uName = localStorage.getItem('myUser');
    let currentItem = {};
    let selectedVariant = "";
    let finalBase64 = "";

    // Hi·ªÉn th·ªã th√¥ng tin User
    document.getElementById('uName').innerText = uName;
    document.getElementById('uBal').parentElement.style.display = 'none';

    // --- 3. ƒê·ªäNH NGHƒ®A C√ÅC H√ÄM X·ª¨ L√ù (G√°n v√†o window) ---

    // H√†m 1: M·ªü Menu
    window.toggleMenu = function() {
        document.getElementById('mainMenu').classList.toggle('active');
    }

    // H√†m 2: ƒêƒÉng xu·∫•t
    window.doLogout = function() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'index.html';
    }

    // H√†m 3: M·ªü Modal Mua/ƒê·∫∑t ƒë∆°n
    window.openModal = function(type, name, price, variants = []) {
        console.log("ƒêang m·ªü modal:", name); // Log ki·ªÉm tra
        currentItem = { type, name, price };
        selectedVariant = "";
        finalBase64 = "";
        
        document.getElementById('mName').innerText = name;
        document.getElementById('accUser').value = uName;
        document.getElementById('buyModal').style.display = 'flex';
        
        // Reset form
        document.getElementById('hiveImg').value = "";
        document.getElementById('uploadBtnText').innerHTML = '<i class="fa-solid fa-camera"></i> Ch·ªçn ·∫£nh t·ªï ong';
        document.getElementById('previewArea').style.display = 'none';

        if(type === 'gamepass') {
            document.getElementById('priceRow').style.display = 'block';
            document.getElementById('mPrice').innerText = price.toLocaleString() + 'ƒë';
            document.getElementById('boostArea').style.display = 'none';
            document.getElementById('variantArea').style.display = 'none';
            document.getElementById('modalTitle').innerText = "MUA GAMEPASS";
        } else {
            document.getElementById('priceRow').style.display = 'none';
            document.getElementById('boostArea').style.display = 'block';
            document.getElementById('accPass').value = "";
            document.getElementById('materialNote').value = "";
            document.getElementById('modalTitle').innerText = "ƒê·∫∂T C√ÄY THU√ä";
            
            // X·ª≠ l√Ω n√∫t ch·ªçn bi·∫øn th·ªÉ
            const vArea = document.getElementById('variantArea');
            vArea.innerHTML = '';
            if(variants && variants.length > 0) {
                vArea.style.display = 'flex';
                variants.forEach(v => {
                    // T·∫°o n√∫t ch·ªçn b·∫±ng HTML string c√≥ onclick g·ªçi window.selectVar
                    let btn = document.createElement('div');
                    btn.className = 'variant-btn';
                    btn.innerText = v;
                    btn.onclick = function() { window.selectVar(this, v); };
                    vArea.appendChild(btn);
                });
            } else { 
                vArea.style.display = 'none'; 
            }
        }
    }

    // H√†m 4: Ch·ªçn bi·∫øn th·ªÉ (Mask/Tool)
    window.selectVar = function(el, val) {
        document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        selectedVariant = val;
    }

    // H√†m 5: N√©n ·∫£nh
    window.compressImage = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 300; 
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    finalBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('imgPreview').src = finalBase64;
                    document.getElementById('previewArea').style.display = 'block';
                    document.getElementById('uploadBtnText').innerText = "ƒê√£ ch·ªçn ·∫£nh!";
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // H√†m 6: G·ª¨I ƒê∆†N (QUAN TR·ªåNG)
    window.processOrder = async function() {
        const acc = document.getElementById('accUser').value;
        const btn = document.querySelector('.btn-primary');

        if(currentItem.type === 'gamepass') {
            if(!acc) return alert("Thi·∫øu t√™n Acc!");
            await sendToFirebase(currentItem.name, currentItem.price, acc, "Kh√¥ng c·∫ßn", "Ch·ªù x·ª≠ l√Ω", "", "gamepass");
        } else {
            let pass = document.getElementById('accPass').value;
            let note = document.getElementById('materialNote').value;
            
            if(!acc || !pass) return alert("Nh·∫≠p ƒë·ªß T√†i kho·∫£n & M·∫≠t kh·∫©u!");
            if(document.getElementById('variantArea').style.display !== 'none' && !selectedVariant) return alert("Vui l√≤ng ch·ªçn lo·∫°i v·∫≠t ph·∫©m!");
            
            let finalName = selectedVariant ? `${currentItem.name} (${selectedVariant})` : currentItem.name;
            await sendToFirebase(finalName, 0, acc, pass, "ƒêang x√©t gi√°", note, "boost");
        }
    }

    // H√†m ph·ª•: ƒê·∫©y l√™n Firebase
    async function sendToFirebase(name, price, acc, pass, status, note, type) {
        const btn = document.querySelector('.btn-primary');
        btn.innerText = "ƒêang g·ª≠i...";
        btn.disabled = true;

        try {
            await addDoc(collection(db, "orders"), {
                acc: acc,
                pass: pass,
                service: name,
                price: price,
                note: note,
                img: finalBase64,
                type: type,
                status: status,
                createdAt: new Date().toISOString()
            });
            alert("‚úÖ G·ª≠i ƒë∆°n th√†nh c√¥ng!");
            document.getElementById('buyModal').style.display = 'none';
        } catch (e) {
            console.error(e);
            alert("L·ªói: " + e.message);
        }
        btn.innerText = "X√ÅC NH·∫¨N";
        btn.disabled = false;
    }

    // H√†m 7: Th√¥ng b√°o & Menu
    window.toggleNotif = function() {
        const box = document.getElementById('notif-box');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    }

    // --- 4. KH·ªûI T·∫†O GIAO DI·ªÜN ---
    const menuBox = document.getElementById('mainMenu');
    menuBox.innerHTML = `
        <div style="padding:10px; font-size:12px; color:#888; border-bottom:1px solid #333">Acc: <b>${uName}</b></div>
        <a href="index.html" class="menu-item">Trang ch·ªß</a>
        <a href="dashboard.html" class="menu-item">Shop V·∫≠t Ph·∫©m</a>
        <a href="history.html" class="menu-item">L·ªãch S·ª≠ ƒê∆°n</a>
        <a href="#" onclick="window.doLogout()" class="menu-item logout" style="color:#ef4444">ƒêƒÉng xu·∫•t</a>
    `;

    // --- 5. L·∫ÆNG NGHE TH√îNG B√ÅO ---
    const q = query(collection(db, "orders"), where("acc", "==", uName));
    onSnapshot(q, (snapshot) => {
        const contentBox = document.getElementById('notif-content');
        let hasNotif = false;
        contentBox.innerHTML = '';

        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            if(data.status === "Ch·ªù x√°c nh·∫≠n") {
                hasNotif = true;
                contentBox.innerHTML += `
                    <div class="notif-item" style="border-bottom:1px solid #333; padding:10px 0;">
                        <b style="color:#fff">Admin b√°o gi√°:</b> ${data.service}<br>
                        Gi√°: <b style="color:#ef4444">${data.price.toLocaleString()}ƒë</b>
                        <div style="display:flex; gap:5px; margin-top:5px">
                            <button onclick="window.replyPrice('${id}', true)" style="background:#22c55e; border:none; color:white; padding:5px;">ƒê·ªìng √Ω</button>
                            <button onclick="window.replyPrice('${id}', false)" style="background:#ef4444; border:none; color:white; padding:5px;">H·ªßy</button>
                        </div>
                    </div>`;
            }
        });
        document.getElementById('bell-dot').style.display = hasNotif ? 'block' : 'none';
        if(!hasNotif) contentBox.innerHTML = '<p style="text-align:center; color:#999; font-size:12px">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p>';
    });

    // H√†m ph·∫£n h·ªìi gi√°
    window.replyPrice = async function(id, isAgree) {
        if(isAgree) {
            await updateDoc(doc(db, "orders", id), { status: "ƒêang x·ª≠ l√Ω" });
            alert("ƒê√£ ch·ªët ƒë∆°n!");
        } else {
            await updateDoc(doc(db, "orders", id), { status: "Kh√°ch h·ªßy" });
            alert("ƒê√£ h·ªßy ƒë∆°n.");
        }
        document.getElementById('notif-box').style.display = 'none';
    }

    // ƒê√≥ng menu khi click ra ngo√†i
    document.addEventListener('click', function(e) { 
        if (!e.target.closest('.bell-wrapper')) document.getElementById('notif-box').style.display = 'none'; 
        if (!e.target.closest('.menu-toggle') && !e.target.closest('.mobile-menu')) document.getElementById('mainMenu').classList.remove('active');
    });

</script>
</body>
</html>
