<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cửa Hàng - GENSAISHOP</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-inner">
            <img class="logo-img" onclick="window.location.href='index.html'" alt="GENSAI SHOP">
            
            <div style="display:flex; align-items:center;">
                <div class="bell-wrapper" onclick="toggleNotif()">
                    <i class="fa-solid fa-bell"></i>
                    <div id="bell-dot" class="bell-dot"></div>
                    <div id="notif-box" class="notif-box">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#fff;">Thông Báo</h4>
                        <div id="notif-content"></div>
                    </div>
                </div>
                <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
            </div>
            
            <div class="mobile-menu" id="mainMenu"></div>
        </div>
    </nav>

    <div class="container">
        <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center">
            <h3 style="font-size:16px; color:#fff">Chào, <span id="uName" style="color:#3b82f6">...</span></h3>
            <div style="font-size:14px; font-weight:bold; color:#fff">Số dư: <span id="uBal" style="color:#22c55e">0</span>đ</div>
        </div>

        <div class="section-header"><i class="fa-solid fa-ticket"></i> Mua Gamepass</div>
        <div class="grid">
            <div class="card">
                <img src="https://i.postimg.cc/7Lrp7X49/tum-voucherler-bee-swarm-13751871.png">
                <div class="card-body">
                    <div class="card-title">Bear Bee Voucher</div>
                    <div class="price">120.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Bear Bee Voucher', 120000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/3wZbGT9c/tum-voucherler-bee-swarm-13751871-1.png">
                <div class="card-body">
                    <div class="card-title">Cub Buddy Voucher</div>
                    <div class="price">80.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'Cub Buddy Voucher', 80000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/Px336Qg7/tum-voucherler-bee-swarm-13751871-2.png">
                <div class="card-body">
                    <div class="card-title">x2 Bee Gather</div>
                    <div class="price">60.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Bee Gather', 60000)">MUA NGAY</button>
                </div>
            </div>
            <div class="card">
                <img src="https://i.postimg.cc/WpyYgS6N/tum-voucherler-bee-swarm-13751871-3.png">
                <div class="card-body">
                    <div class="card-title">x2 Convert Speed</div>
                    <div class="price">60.000đ</div>
                    <button class="btn-buy" onclick="openModal('gamepass', 'x2 Convert Speed', 60000)">MUA NGAY</button>
                </div>
            </div>
        </div>

        <div class="section-header" style="border-left-color: #3b82f6;"><i class="fa-solid fa-shield-halved"></i> Dịch vụ Cày Thuê</div>
        <div class="grid">
            
            <div class="card">
                <img src="https://i.postimg.cc/52vXFhkp/Picsart-26-01-30-13-32-27-533.png">
                <div class="card-body">
                    <div class="card-title">Basic Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Basic Mask', 0, ['Honey Mask', 'Fire Mask', 'Bubble Mask'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/d0LSB9rp/Picsart-26-01-30-13-27-53-922.png">
                <div class="card-body">
                    <div class="card-title">Advanced Masks</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Advanced Mask', 0, ['Evil Mask', 'Diamond Mask', 'Gummy Mask'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/fRFvwQS5/Picsart-26-01-30-13-23-20-403.png">
                <div class="card-body">
                    <div class="card-title">Endgame Tools</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Endgame Tool', 0, ['Dark Scythe', 'Tide Popper', 'Gummyballer'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/cJtjMmNY/Screenshot-20260130-123550-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Honeycomb Belt</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Honeycomb Belt', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/C1jQ9x5p/Screenshot-20260130-123640-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Coconut Clogs</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Coconut Clogs', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0QmTxCtT/images-(17).jpg">
                <div class="card-body">
                    <div class="card-title">Gummy Boots</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Boots', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/0jj7DVLC/Screenshot-20260130-125715-Discord.jpg">
                <div class="card-body">
                    <div class="card-title">Guards (Cobalt/Crimson)</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Guards', 0, ['Cobalt Guard', 'Crimson Guard'])">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/B6Vj94VB/images-(18).jpg">
                <div class="card-body">
                    <div class="card-title">Vicious Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Vicious Bee', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>

            <div class="card">
                <img src="https://i.postimg.cc/pVmZ9TxS/Gummy-Bee.webp">
                <div class="card-body">
                    <div class="card-title">Gummy Bee</div>
                    <div class="price" style="color:#ef4444; font-size:13px">Thương lượng</div>
                    <button class="btn-buy" onclick="openModal('boost', 'Gummy Bee', 0)">ĐẶT ĐƠN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-bottom:15px; color:#fff" id="modalTitle">...</h3>
            <p>Vật phẩm: <b id="mName">...</b></p>
            <p id="priceRow" style="margin-bottom:10px">Giá: <b id="mPrice" style="color:red">...</b></p>
            
            <div id="variantArea" class="variant-group" style="display:none"></div>
            <input type="text" id="accUser" class="input-box" placeholder="Username Roblox...">
            
            <div id="boostArea" style="display:none">
                <input type="password" id="accPass" class="input-box" placeholder="Mật khẩu (Bắt buộc)...">
                <label style="font-size:13px; font-weight:bold; display:block; margin:10px 0 5px; color:#ccc">Nguyên liệu & Tiền hiện có:</label>
                <textarea id="materialNote" class="input-box" style="height:60px" placeholder="Ví dụ: Đủ nl, 500 tỷ honey..."></textarea>
                
                <div class="upload-btn-wrapper">
                    <button class="btn-upload" id="uploadBtnText"><i class="fa-solid fa-camera"></i> Chọn ảnh tổ ong</button>
                    <input type="file" id="hiveImg" accept="image/*" onchange="compressImage(this)">
                </div>
                
                <div id="previewArea" style="display:none; text-align:center; margin-bottom:10px">
                    <img id="imgPreview" style="max-height:80px; border:1px solid #444; border-radius:8px">
                </div>

                <div style="font-size:11px; background:#222; padding:10px; border-radius:8px; color:#aaa; border:1px solid #333">
                    <i class="fa-solid fa-circle-info"></i> Dựa vào tình trạng acc, Admin sẽ báo giá lại sau.
                </div>
            </div>

            <button class="btn-primary" onclick="processOrder()">XÁC NHẬN</button>
            <button onclick="document.getElementById('buyModal').style.display='none'" style="width:100%; border:none; background:none; margin-top:10px; color:#888; cursor:pointer">Hủy</button>
        </div>
    </div>

        <script>
        // --- CẤU HÌNH ---
        // Thay link này bằng link Render của bạn (đừng quên /api ở cuối nếu cần, nhưng code backend mình viết không cần)
        const BACKEND_URL = 'https://gensai-backend.onrender.com'; 
        
        // KIỂM TRA ĐĂNG NHẬP
        if(!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
        const uName = localStorage.getItem('myUser');
        
        // MENU
        const menuBox = document.getElementById('mainMenu');
        menuBox.innerHTML = `
            <div style="padding:10px; font-size:12px; color:#888; border-bottom:1px solid #333">Acc: <b>${uName}</b></div>
            <a href="index.html" class="menu-item">Trang chủ</a>
            <a href="dashboard.html" class="menu-item">Shop Vật Phẩm</a>
            <a href="deposit.html" class="menu-item">Nạp Tiền</a>
            <a href="history.html" class="menu-item">Lịch Sử Đơn</a>
            <a href="#" onclick="doLogout()" class="menu-item logout" style="color:#ef4444">Đăng xuất</a>
        `;
        function toggleMenu() { menuBox.classList.toggle('active'); }
        function doLogout() { localStorage.removeItem('isLoggedIn'); window.location.href = 'index.html'; }

        // SỐ DƯ (Tạm thời vẫn lấy ở Local, sau này nên nâng cấp lấy từ Server)
        let balance = parseInt(localStorage.getItem('myBalance')) || 0;
        document.getElementById('uName').innerText = uName;
        document.getElementById('uBal').innerText = balance.toLocaleString();

        let currentItem = {}, selectedVariant = "", finalBase64 = "";

        // MỞ MODAL
        function openModal(type, name, price, variants = []) {
            currentItem = { type, name, price }; 
            selectedVariant = ""; 
            finalBase64 = "";
            
            document.getElementById('mName').innerText = name;
            document.getElementById('accUser').value = uName; // Tự điền tên user
            document.getElementById('buyModal').style.display = 'flex';
            
            // Reset Upload
            document.getElementById('hiveImg').value = "";
            document.getElementById('uploadBtnText').innerHTML = '<i class="fa-solid fa-camera"></i> Chọn ảnh tổ ong';
            document.getElementById('previewArea').style.display = 'none';

            if(type === 'gamepass') {
                document.getElementById('priceRow').style.display = 'block';
                document.getElementById('mPrice').innerText = price.toLocaleString() + 'đ';
                document.getElementById('boostArea').style.display = 'none';
                document.getElementById('variantArea').style.display = 'none';
                document.getElementById('modalTitle').innerText = "MUA GAMEPASS";
            } else {
                document.getElementById('priceRow').style.display = 'none';
                document.getElementById('boostArea').style.display = 'block';
                document.getElementById('accPass').value = "";
                document.getElementById('materialNote').value = "";
                document.getElementById('modalTitle').innerText = "ĐẶT CÀY THUÊ";
                
                const vArea = document.getElementById('variantArea'); 
                vArea.innerHTML = '';
                if(variants.length > 0) {
                    vArea.style.display = 'flex';
                    variants.forEach(v => { 
                        vArea.innerHTML += `<div class="variant-btn" onclick="selectVar(this, '${v}')">${v}</div>`; 
                    });
                } else { vArea.style.display = 'none'; }
            }
        }

        // NÉN ẢNH
        function compressImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        finalBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('imgPreview').src = finalBase64;
                        document.getElementById('previewArea').style.display = 'block';
                        document.getElementById('uploadBtnText').innerText = "Đã nén ảnh!";
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function selectVar(el, val) {
            document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected'); 
            selectedVariant = val;
        }

        // --- XỬ LÝ GỬI ĐƠN LÊN SERVER ---
        async function processOrder() {
            let acc = document.getElementById('accUser').value;
            
            if(currentItem.type === 'gamepass') {
                if(!acc) return alert("Vui lòng nhập Username!");
                if(balance < currentItem.price) return alert("Không đủ tiền!");
                
                // Trừ tiền local (Sau này trừ ở server sau)
                balance -= currentItem.price;
                localStorage.setItem('myBalance', balance);
                document.getElementById('uBal').innerText = balance.toLocaleString();

                await sendOrderToServer(currentItem.name, currentItem.price, acc, "Không cần", "Chờ xử lý", "", "gamepass");
                alert("Mua thành công! Đơn đã gửi tới Admin."); 
                document.getElementById('buyModal').style.display = 'none';

            } else {
                let pass = document.getElementById('accPass').value;
                let note = document.getElementById('materialNote').value;
                
                if(!acc || !pass) return alert("Vui lòng nhập Tài khoản và Mật khẩu!");
                if(document.getElementById('variantArea').style.display !== 'none' && !selectedVariant) return alert("Vui lòng chọn loại vật phẩm!");
                
                let finalName = selectedVariant ? `${currentItem.name} (${selectedVariant})` : currentItem.name;
                
                // Gửi đơn cày thuê
                await sendOrderToServer(finalName, 0, acc, pass, "Đang xét giá", note, "boost");
                
                alert("Đã gửi đơn lên hệ thống! Vui lòng theo dõi chuông thông báo.");
                document.getElementById('buyModal').style.display = 'none';
            }
        }

        // HÀM GỌI API BACKEND (Quan trọng nhất)
        async function sendOrderToServer(name, price, acc, pass, status, note, type) {
            const payload = {
                type: type,
                service: name,
                acc: acc,
                pass: pass,
                note: note,
                price: price,
                img: finalBase64, // Ảnh đã nén
                status: status
            };

            try {
                const res = await fetch(`${BACKEND_URL}/api/order/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                console.log("Server trả về:", data);
            } catch (err) {
                alert("Lỗi kết nối Server! Kiểm tra lại mạng.");
                console.error(err);
            }
        }

        // --- HỆ THỐNG THÔNG BÁO ONLINE ---
        function toggleNotif() {
            const box = document.getElementById('notif-box');
            box.style.display = (box.style.display === 'block') ? 'none' : 'block';
            checkBell(); // Gọi ngay khi mở
        }

        // Kiểm tra thông báo mỗi 5 giây
        setInterval(checkBell, 5000); 

        async function checkBell() {
            try {
                // Lấy danh sách đơn từ Server về
                const res = await fetch(`${BACKEND_URL}/api/order/list`);
                const allOrders = await res.json();
                
                // Lọc ra đơn của user hiện tại (Dựa theo tên Acc Roblox)
                // Lưu ý: Đây là cách tạm thời. Đúng ra phải có API /my-orders
                const myOrders = allOrders.filter(o => o.acc === uName);
                
                // Tìm các đơn Admin đã báo giá (Status = 'Chờ xác nhận')
                const pendingConfirm = myOrders.filter(o => o.status === "Chờ xác nhận");

                document.getElementById('bell-dot').style.display = pendingConfirm.length > 0 ? 'block' : 'none';
                const contentBox = document.getElementById('notif-content');
                contentBox.innerHTML = '';
                
                if(pendingConfirm.length === 0) {
                    contentBox.innerHTML = '<p style="text-align:center; color:#999; font-size:12px">Không có thông báo mới.</p>';
                } else {
                    pendingConfirm.forEach(h => {
                        contentBox.innerHTML += `
                            <div class="notif-item" style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px">
                                <b style="color:#fff">Admin báo giá:</b> ${h.service}<br>
                                Giá chốt: <b style="color:#ef4444">${h.price.toLocaleString()}đ</b>
                                <div style="display:flex; gap:5px; margin-top:5px;">
                                    <button class="notif-btn" style="background:#22c55e; color:#fff; border:none; padding:5px; border-radius:3px; cursor:pointer" onclick="replyPrice('${h._id}', true, ${h.price})">Đồng ý</button>
                                    <button class="notif-btn" style="background:#ef4444; color:#fff; border:none; padding:5px; border-radius:3px; cursor:pointer" onclick="replyPrice('${h._id}', false, 0)">Hủy</button>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                console.log("Lỗi check thông báo");
            }
        }

        // USER PHẢN HỒI GIÁ
        async function replyPrice(id, isAgree, price) {
            if(isAgree) {
                if(balance >= price) {
                    balance -= price;
                    localStorage.setItem('myBalance', balance);
                    document.getElementById('uBal').innerText = balance.toLocaleString();
                    
                    // Gửi cập nhật lên Server
                    await updateOrderStatus(id, "Đang xử lý");
                    alert("Đã chốt đơn! Admin sẽ bắt đầu cày.");
                } else { 
                    return alert("Số dư không đủ! Vui lòng nạp thêm."); 
                }
            } else {
                await updateOrderStatus(id, "Bị hủy");
                alert("Đã hủy đơn hàng.");
            }
            
            document.getElementById('notif-box').style.display = 'none';
            checkBell(); // Load lại thông báo
        }

        async function updateOrderStatus(id, status) {
            await fetch(`${BACKEND_URL}/api/order/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, status: status })
            });
        }

        document.addEventListener('click', function(e) { 
            if (!e.target.closest('.bell-wrapper')) document.getElementById('notif-box').style.display = 'none'; 
            if (!e.target.closest('.menu-toggle') && !e.target.closest('.mobile-menu')) document.getElementById('mainMenu').classList.remove('active');
        });
    </script>
