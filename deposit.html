// --- SCRIPT NẠP THẺ TỰ ĐỘNG (Dán vào deposit.html) ---

// Thay cái này bằng Link Render của bạn (bỏ dấu / ở cuối nếu có)
const BACKEND_URL = "https://gensai-backend.onrender.com"; 

async function sendCardToAPI() {
    const type = document.getElementById('cardType').value;
    const amount = document.getElementById('cardAmount').value;
    const seri = document.getElementById('cardSeri').value;
    const pin = document.getElementById('cardPin').value;
    const uName = localStorage.getItem('myUser');

    if(!type || !amount || !seri || !pin) return alert("Vui lòng nhập đầy đủ thông tin!");

    const btn = document.querySelector('.btn-primary');
    const oldText = btn.innerText;
    btn.innerText = "Đang kết nối Server...";
    btn.disabled = true;

    try {
        // 1. Gửi thẻ lên Server
        const res = await fetch(`${BACKEND_URL}/api/deposit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type, amount, serial: seri, pin, username: uName })
        });
        const data = await res.json();

        if(data.status === 1) {
            // 2. Server đã nhận, bắt đầu chế độ chờ kết quả
            const reqId = data.request_id;
            let dotCount = 0;
            
            // Hàm kiểm tra liên tục mỗi 3 giây
            let checkInterval = setInterval(async () => {
                dotCount = (dotCount + 1) % 4;
                btn.innerText = "Đang duyệt thẻ" + ".".repeat(dotCount);

                try {
                    const checkRes = await fetch(`${BACKEND_URL}/api/check/${reqId}`);
                    const checkData = await checkRes.json();

                    if(checkData.status === 'success') {
                        clearInterval(checkInterval);
                        
                        // CỘNG TIỀN
                        let currentBal = parseInt(localStorage.getItem('myBalance')) || 0;
                        let newBal = currentBal + checkData.amount;
                        localStorage.setItem('myBalance', newBal);
                        
                        // LƯU LỊCH SỬ
                        let h = JSON.parse(localStorage.getItem('myDepositHistory')) || [];
                        h.unshift({ 
                            id: reqId, amount: checkData.amount, method: type, 
                            date: new Date().toLocaleString(), status: 'Thành công' 
                        });
                        localStorage.setItem('myDepositHistory', JSON.stringify(h));

                        alert(`Nạp thành công ${checkData.amount.toLocaleString()}đ!`);
                        window.location.reload();
                    } 
                    else if(checkData.status === 'wrong') {
                        clearInterval(checkInterval);
                        alert("Thất bại: Thẻ sai hoặc đã được sử dụng!");
                        btn.innerText = oldText;
                        btn.disabled = false;
                    }
                    // Nếu status là 'pending' thì cứ để nó quay tiếp
                } catch (e) { console.log("Đang chờ server..."); }
            }, 3000); // 3 giây hỏi 1 lần

        } else {
            alert("Lỗi gửi thẻ: " + data.message);
            btn.innerText = oldText;
            btn.disabled = false;
        }

    } catch (err) {
        console.error(err);
        alert("Server đang khởi động (mất khoảng 1 phút). Vui lòng thử lại!");
        btn.innerText = oldText;
        btn.disabled = false;
    }
}
