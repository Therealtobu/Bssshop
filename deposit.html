<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nạp Tiền - GENSAISHOP</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-inner">
            <img class="logo-img" onclick="window.location.href='index.html'" alt="GENSAI SHOP">
            <div style="display:flex; align-items:center;">
                <div class="bell-wrapper" onclick="toggleNotif()">
                    <i class="fa-solid fa-bell"></i>
                    <div id="bell-dot" class="bell-dot"></div>
                    <div id="notif-box" class="notif-box">
                        <h4 style="margin-bottom:10px; font-size:14px; color:#fff">Thông Báo</h4>
                        <div id="notif-content"></div>
                    </div>
                </div>
                <div class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
            </div>
            <div class="mobile-menu" id="mainMenu"></div>
        </div>
    </nav>

    <div class="container">
        <div class="auth-box" style="max-width:600px; margin-top:30px">
            <h3 style="text-align:center; margin-bottom:25px; text-transform:uppercase; letter-spacing:1px; color:#fff">Nạp Số Dư</h3>
            
            <div class="tab-header">
                <div id="tab1" class="tab-btn active" onclick="switchTab('bank')">CHUYỂN KHOẢN</div>
                <div id="tab2" class="tab-btn" onclick="switchTab('card')">THẺ CÀO (AUTO)</div>
                <div id="tab3" class="tab-btn" onclick="switchTab('code')">NHẬP CODE</div>
            </div>

            <div id="bank-area">
                <div style="background:#222; padding:20px; border-radius:12px; text-align:center; border:1px solid #333; margin-bottom:20px">
                    <p style="font-size:13px; color:#aaa; margin-bottom:5px">NGÂN HÀNG MB BANK</p>
                    <p style="font-size:24px; font-weight:800; color:#fff; margin-bottom:5px; letter-spacing:1px">0123 456 789</p>
                    <p style="font-size:14px; color:#fff">Chủ TK: <b style="text-transform:uppercase">Nguyen Van A</b></p>
                    <div style="margin-top:15px; background:#333; color:#fff; padding:8px; border-radius:6px; font-size:13px">
                        Nội dung: <b>NAP GENSAI</b>
                    </div>
                </div>
                <p style="text-align:center; font-size:12px; color:#666; margin-top:15px">Chuyển xong vui lòng chụp ảnh gửi Admin qua Discord/Facebook để cộng tiền.</p>
            </div>

            <div id="card-area" style="display:none">
                <select id="cardType" class="input-box" style="background:#1f1f1f; color:white">
                    <option value="">-- Chọn loại thẻ --</option>
                    <option value="VIETTEL">Viettel</option>
                    <option value="VINAPHONE">Vinaphone</option>
                    <option value="MOBIFONE">Mobifone</option>
                    <option value="ZING">Zing</option>
                </select>
                <select id="cardAmount" class="input-box" style="background:#1f1f1f; color:white">
                    <option value="">-- Chọn mệnh giá --</option>
                    <option value="10000">10.000đ</option>
                    <option value="20000">20.000đ</option>
                    <option value="50000">50.000đ</option>
                    <option value="100000">100.000đ</option>
                    <option value="200000">200.000đ</option>
                    <option value="500000">500.000đ</option>
                </select>
                <input type="text" id="cardSeri" class="input-box" placeholder="Số Seri">
                <input type="text" id="cardPin" class="input-box" placeholder="Mã thẻ (Mã nạp)">
                
                <button class="btn-primary" onclick="sendCardToAPI()">NẠP THẺ NGAY</button>
                <p style="font-size:11px; color:#aaa; margin-top:10px; text-align:center">
                    <i class="fa-solid fa-bolt"></i> Hệ thống xử lý tự động 24/7. Vui lòng giữ thẻ cho đến khi báo thành công.
                </p>
            </div>

            <div id="code-area" style="display:none">
                <input type="text" id="giftCode" class="input-box" placeholder="Nhập mã Giftcode...">
                <button class="btn-primary" onclick="redeemCode()">KÍCH HOẠT</button>
            </div>

        </div>
    </div>

    <script>
        if(!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
        const uName = localStorage.getItem('myUser');
        const menuBox = document.getElementById('mainMenu');
        
        // ========================================================
        // ⚠️ THAY LINK RENDER CỦA BẠN VÀO DÒNG DƯỚI ĐÂY
        const BACKEND_URL = "https://gensai-backend.onrender.com"; 
        // ========================================================

        menuBox.innerHTML = `<div style="padding:10px; font-size:12px; color:#888; border-bottom:1px solid #333">Acc: <b>${uName}</b></div><a href="index.html" class="menu-item">Trang chủ</a><a href="dashboard.html" class="menu-item">Shop Vật Phẩm</a><a href="deposit.html" class="menu-item">Nạp Tiền</a><a href="history.html" class="menu-item">Lịch Sử Đơn</a><a href="#" onclick="doLogout()" class="menu-item logout" style="color:#ef4444">Đăng xuất</a>`;
        function toggleMenu() { menuBox.classList.toggle('active'); }
        function doLogout() { localStorage.removeItem('isLoggedIn'); window.location.href = 'index.html'; }

        function switchTab(t) {
            document.getElementById('bank-area').style.display = (t=='bank') ? 'block' : 'none';
            document.getElementById('card-area').style.display = (t=='card') ? 'block' : 'none';
            document.getElementById('code-area').style.display = (t=='code') ? 'block' : 'none';
            document.getElementById('tab1').className = (t=='bank') ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab2').className = (t=='card') ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab3').className = (t=='code') ? 'tab-btn active' : 'tab-btn';
        }

        // 3. HÀM GỬI THẺ (ĐÃ SỬA CHUẨN STATUS SỐ)
        async function sendCard() {
            const telco = document.getElementById('telco').value;
            const amount = document.getElementById('amount').value;
            const serial = document.getElementById('serial').value;
            const pin = document.getElementById('pin').value;
            const btn = document.querySelector('.btn-primary');
            const statusDiv = document.getElementById('statusResult');

            if(!serial || !pin) return alert("Vui lòng nhập Seri và Mã thẻ!");

            // Hiệu ứng đang gửi
            btn.innerText = "Đang xử lý...";
            btn.disabled = true;
            statusDiv.innerHTML = '<span style="color:#eab308"><i class="fa-solid fa-spinner fa-spin"></i> Đang kết nối Server...</span>';

            try {
                // Gửi dữ liệu sang Server Render của bạn
                const res = await fetch(`${SERVER_URL}/api/deposit`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telco: telco,
                        amount: parseInt(amount),
                        serial: serial,
                        pin: pin,
                        username: uName
                    })
                });

                // Nhận kết quả JSON từ Server
                const data = await res.json();
                
                // Lấy mã số status (1, 2, 3, 4, 99...)
                const st = parseInt(data.status); 

                // --- XỬ LÝ TỪNG TRẠNG THÁI SỐ ---
                if (st === 1) {
                    statusDiv.innerHTML = `<span style="color:#22c55e">✅ Nạp thành công! Tiền đã được cộng.</span>`;
                    document.getElementById('serial').value = "";
                    document.getElementById('pin').value = "";
                    
                } else if (st === 2) {
                    statusDiv.innerHTML = `<span style="color:#ef4444">❌ Lỗi: Sai mệnh giá thẻ! (Mất thẻ)</span>`;
                    
                } else if (st === 3) {
                    statusDiv.innerHTML = `<span style="color:#ef4444">❌ Lỗi: Thẻ sai, đã sử dụng hoặc nhập sai mã!</span>`;
                    
                } else if (st === 4) {
                    statusDiv.innerHTML = `<span style="color:#eab308">⚠️ Lỗi: Hệ thống gạch thẻ đang bảo trì. Thử lại sau!</span>`;
                    
                } else if (st === 99) {
                    statusDiv.innerHTML = `<span style="color:#3b82f6">⏳ Thẻ đang chờ duyệt... Vui lòng đợi 1-2 phút!</span>`;
                    document.getElementById('serial').value = "";
                    document.getElementById('pin').value = "";
                    
                } else {
                    // Nếu trả về số khác lạ
                    statusDiv.innerHTML = `<span style="color:#ef4444">❌ Lỗi không xác định: ${data.message || "Báo Admin check lại!"}</span>`;
                }

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span style="color:#ef4444">⚠️ Lỗi mạng hoặc Server không phản hồi (Cannot GET). Kiểm tra lại Render!</span>`;
            }

            // Mở khóa nút bấm
            btn.innerText = "NẠP NGAY";
            btn.disabled = false;
        }


        // --- HÀM NHẬP GIFTCODE (THỦ CÔNG) ---
        function redeemCode() {
            const code = document.getElementById('giftCode').value.trim();
            if(!code) return alert("Vui lòng nhập Code!");
            
            // Xử lý Code Gift (Logic cũ vẫn giữ để Admin tặng quà)
            let usedCodes = JSON.parse(localStorage.getItem('usedCodes')) || [];
            if(usedCodes.includes(code)) return alert("Code này đã dùng rồi!");

            let money = 0;
            if(code === "GENSAI10K") money = 10000; // Ví dụ mã code cứng
            if(code === "OPEN20K") money = 20000;

            if(money > 0) {
                let bal = parseInt(localStorage.getItem('myBalance')) || 0;
                localStorage.setItem('myBalance', bal + money);
                usedCodes.push(code);
                localStorage.setItem('usedCodes', JSON.stringify(usedCodes));
                
                let h = JSON.parse(localStorage.getItem('myDepositHistory')) || [];
                h.unshift({ id: code, amount: money, method: 'Giftcode', date: new Date().toLocaleString(), status: 'Thành công' });
                localStorage.setItem('myDepositHistory', JSON.stringify(h));

                alert("Nhập Code thành công! Cộng " + money.toLocaleString() + "đ");
                window.location.reload();
            } else {
                alert("Mã Code không tồn tại!");
            }
        }

        // Logic Chuông thông báo
        function toggleNotif() { document.getElementById('notif-box').style.display = document.getElementById('notif-box').style.display==='block'?'none':'block'; }
        document.addEventListener('click', function(e) { if (!e.target.closest('.menu-toggle') && !e.target.closest('.mobile-menu')) menuBox.classList.remove('active'); if(!e.target.closest('.bell-wrapper')) document.getElementById('notif-box').style.display='none'; });
    </script>
</body>
</html>
